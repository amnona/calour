<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
<style>

.axis path {
  display: none;
}
.pixel {
  /*image-rendering: pixelated;*/
  padding: 0px;
  margin: 0px;
  border: 0px;
    image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
    image-rendering: -moz-crisp-edges;          /* Firefox                        */
    image-rendering: -o-crisp-edges;            /* Opera                          */
    image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
    image-rendering: pixelated; /* Chrome */
    image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
    -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
}

.axis line {
  stroke-opacity: 0.3;
  shape-rendering: crispEdges;
}

#reset {
  position: absolute;
  top: 20px;
  left: 20px;
}

#zoomplus {
  position: absolute;
  top: 40px;
  left: 20px;
}

#zoomminus {
  position: absolute;
  top: 40px;
  left: 50px;
}

#moveup {
  position: absolute;
  top: 40px;
  left: 90px;
}

#movedown {
  position: absolute;
  top: 40px;
  left: 120px;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

</style>
</head>
<body>
  <div id="title" style="text-align: center">
    <h1><span id="title_text">Experiment</span></h1>
    Sorted by field <span id='field_name'> NA </span>
  </div>
    <div id="heat-map-div" style="width: 60%; height: 400px; border: 1px solid red; float: left; overflow: hidden;">
      <button id="reset">Reset</button>
      <button id="zoomplus">+</button>
      <button id="zoomminus">-</button>
      <button id="moveup">U</button>
      <button id="movedown">D</button>
      <svg width="750" height="500">
      </svg>
    </div>

    <div id="annotations2" style="margin-left: 10px; width: 34%; height: 400px; border: 1px solid blue; display: inline-block; overflow: scroll;white-space: nowrap;">
      <!--Here goes the annotations!-->
      <b>DBBact annotations</b>
      <p id="annotations">Click on heatmap bacteria to see annotations</p>
    </div>
    <div id="selection" style="float:none; margin-top: 10px; border: 1px solid grey">
      <!--Here goes the selection!-->
      <p><b>Taxonomy:</b><span id="taxonomy">NA</span></p>
      <p>SampleID:<span id="sampleid">NA</span></p>
      <p>Use mouse or -/= for zooming bacteria, shift+mouse for zooming samples, arrow keys to scroll up/down in heatmap <span style="float: right"> For more analysis options, download <a href='https://github.com/amnona/calour' target='_blank'>Calour</a></span></p>
    </div>

<script>  

//**********************************************************
// following variables are set by the external python program
// DO NOT DELETE/CHANGE
var yticklabels = ['NA'];
var ids = ['NA'];
var samples = ['NA'];
var vlines=[];
var xtick_pos=[];
var xtick_labels=[];
var field_name = '';
var title_text = 'Experiment'
// yticklabels go here
// ids go here
// samples go here
// vlines go here
// xtick_pos go here
// xtick_labels go here
// field_name goes here
// title_text goes here
//***********************************************************

var yaxiswidth = 100;
var xaxisheight = 50;

// set the title
document.getElementById("field_name").innerHTML = field_name;
document.getElementById("title_text").innerHTML = title_text;

var heatmap_div = d3.select('#heat-map-div').node();
div_w = heatmap_div.getBoundingClientRect().width;
div_h = heatmap_div.getBoundingClientRect().height;

var svg = d3.select("svg");
var width = +div_w, height = +div_h;

// available display for the heatmap (without axes)
var hwidth = width-yaxiswidth;
var hheight = height-xaxisheight;

  svg.attr("width", width)
  .attr("height", height);

svg.on("click",onclick);

var xScale = d3.scaleLinear()
    .domain([0, width ])
    .range([0, width]);

var yScale = d3.scaleLinear()
    .domain([0, ids.length])
    .range([0.5, ids.length+0.5]);

var heatmapregion = svg
      .append("svg")
      .attr("width",width-yaxiswidth+"px")
      .attr("height",height-xaxisheight+"px")
      .attr("x",yaxiswidth)
      .attr("y",0);

var heatmap = heatmapregion.append("g")
      .append("image")
      .attr("class","pixel")
      .attr("width",samples.length)
      .attr("height",ids.length)
      .attr("xlink:xlink:href", "data:image/png;base64,**image_goes_here**")
      // .attr("xlink:href", "out.png");

var xyratio = get_xyratio();

var xAxis = d3.axisBottom(xScale)
    .tickValues(xtick_pos)
    .tickFormat(function (d,i) {return xtick_labels[i];});

function customTickFunction(d) {
  var dom=yAxis.scale().domain()
  if ((dom[1]-dom[0])<50) {
    return Math.round(dom[1]-dom[0]);
  }
  return 50;
}

var yAxis = d3.axisLeft(yScale)
    .ticks(50)
    .tickFormat(function (d) {return yticklabels[Math.round(d)];});
    yAxis.ticks(customTickFunction());


var gX = svg.append("g")
    .attr("class", "axis axis--x")
    .attr("transform","translate("+yaxiswidth+","+(hheight)+")")
    .call(xAxis);

    console.log(gX)

var gY = svg.append("g")
    .attr("class", "axis axis--y")
    .attr("transform","translate("+yaxiswidth+",0)")
    .call(yAxis);


// The per sample-type vlines
var vline_lines = heatmapregion.append('g');
for (idx=0;idx<vlines.length; idx++) {
  vline_lines.append('line')
      .attr('id', 'vline')
      .attr('class', 'vLine')
      .style("stroke", "white")
      // .style("stroke-dasharray", "1,1")
      .style("stroke-opacity", 1)
      .style("stroke-width", 6*xyratio)
      .attr('x1', vlines[idx]).attr('y1', 0)
      .attr('x2', vlines[idx]).attr('y2', ids.length);
}

// The cursor crosshair
var focus = heatmapregion.append('g');

var xline = focus.append('line')
    .attr('id', 'focusLineX')
    .attr('class', 'focusLine')
    .style("stroke", "white")
    // .style("stroke-dasharray", "1,1")
    .style("stroke-opacity", 0.5)
    .style("stroke-width", 1);

focus.append('line')
    .attr('id', 'focusLineY')
    .attr('class', 'focusLine')
    .style("stroke", "white")
    .style("stroke-opacity", 0.5)
    // .style("stroke-dasharray", "1,1")
    .style("stroke-width", 1*xyratio);

d3.select("#reset")
    .on("click", resetted);

d3.select("#zoomplus")
    .on("click", zoomY);

d3.select("#zoomminus")
    .on("click", unzoomY);

d3.select("#movedown")
    .on("click", moveDown);

d3.select("#moveup")
    .on("click", moveUp);

var initial_scale_factor = hwidth/samples.length

var shiftdown = 0;
var shift_zoom_tx, shift_zoom_k, zoom_k, zoom_ty;
d3.select("body").on("keydown", onkeydown);
d3.select("body").on("keyup", onkey);

var zoom = d3.zoom()
    .scaleExtent([initial_scale_factor, 1000])
    .translateExtent([[0,0],[width/initial_scale_factor,100000000]])
    .on("zoom", zoomed);

heatmapregion.call(zoom);

// and initial zoom to have full screen
resetted()

function onkeydown() {
  if (d3.event.key == '-') {
    unzoomY();
  };
  if (d3.event.key == '=') {
    zoomY();
  };
  if (d3.event.key == 'ArrowDown') {
    moveDown();
  };
  if (d3.event.key == 'ArrowUp') {
    moveUp();
  };
  // and now process the shift
  onkey();  
}


function onkey() {

  shiftdown=d3.event.shiftKey;

  if (shiftdown) {
    xyratio = xyratio * zoom_k / shift_zoom_k;
    zoom_k = shift_zoom_k
    shift_zoom_tx = shift_zoom_tx/(shift_zoom_k);
    heatmapregion.call(zoom.transform, d3.zoomIdentity.scale(shift_zoom_k).translate(shift_zoom_tx,zoom_ty));
    zoom.translateBy(heatmapregion,0,0);
  } else {
    xyratio = xyratio * zoom_k / shift_zoom_k;
    zoom_ty = zoom_ty/shift_zoom_k;
    heatmapregion.call(zoom.transform, d3.zoomIdentity.scale(shift_zoom_k).translate(shift_zoom_tx,zoom_ty));
    zoom.translateBy(heatmapregion,0,0);
  }
  // zoom.scaleExtent([initial_scale_factor*xyratio, 1000]);
  // heatmapregion.call(zoom);
}

function zoomed() {
  tt=d3.event.transform
  if (shiftdown != 0) {
    newt = "translate("+tt.x+","+zoom_ty+") scale("+tt.k+","+zoom_k*xyratio+")";
    shift_zoom_tx = tt.x;
    shift_zoom_k = tt.k;
    gX.call(xAxis.scale(d3.event.transform.rescaleX(xScale)));
    vline_lines.selectAll("#vline").style("stroke-width", 3/tt.k);
    focus.selectAll("#focusLineY").style("stroke-width", 2/tt.k);
  };
  if (shiftdown != 1) {
    newt = "translate("+shift_zoom_tx+","+tt.y+") scale("+shift_zoom_k+","+tt.k*xyratio+")";
    zoom_k = tt.k;
    zoom_ty = tt.y;
    ytransform = d3.zoomIdentity.translate(tt.x,tt.y).scale(tt.k*xyratio);
    gY.call(yAxis.scale(ytransform.rescaleY(yScale)).ticks(customTickFunction()));
    focus.selectAll("#focusLineX").style("stroke-width", 2/(xyratio*tt.k));
  };
  console.log(newt)
  heatmap.attr("transform", newt);
  vline_lines.attr("transform", newt);
  focus.attr("transform", newt);
}


function reset_coords() {
  xyratio = get_xyratio();
  shift_zoom_tx = 0;
  shift_zoom_k = initial_scale_factor;
  zoom_ty = 0;
  zoom_k = initial_scale_factor;
}

function resetted() {
  console.log('reset');
  reset_coords()
  old_shiftdown = shiftdown
  shiftdown=2;
  heatmapregion.call(zoom.transform, d3.zoomIdentity.scale(initial_scale_factor));
  shiftdown=old_shiftdown;
  // The nice transition didn't work with the shift up/down
  // heatmapregion.transition()
  //     .duration(750)
  //     .call(zoom.transform, d3.zoomIdentity.scale(initial_scale_factor));
}

function zoomY() {
  ctrans = d3.zoomTransform(heatmapregion.node());
  ctrans.y = 0;
  // the topmost feature showing in the screen
  screen_start=yAxis.scale().invert(0);

  // move so 0th feature is top row displaying
  // zoom.translateBy(heatmapregion, 0, -tozero/xyratio)
  heatmapregion.call(zoom.transform, ctrans)

  xyratio = xyratio * 2;  
  zoom.translateBy(heatmapregion,0,0);
  newpos = yAxis.scale()(screen_start);
  newpos = -newpos;
  ctrans.y = newpos;
  heatmapregion.call(zoom.transform, ctrans);
}

function unzoomY() {
  ctrans = d3.zoomTransform(heatmapregion.node());
  ctrans.y = 0;
  // the topmost feature showing in the screen
  screen_start=yAxis.scale().invert(0);

  // move so 0th feature is top row displaying
  // zoom.translateBy(heatmapregion, 0, -tozero/xyratio)
  heatmapregion.call(zoom.transform, ctrans)

  xyratio = xyratio / 2;  
  zoom.translateBy(heatmapregion,0,0);
  newpos = yAxis.scale()(screen_start);
  newpos = -newpos;
  ctrans.y = newpos;
  heatmapregion.call(zoom.transform, ctrans);
}


function moveDown() {
  // xyratio = xyratio / 2;
  // zoom.translateBy(svg,0,0);
  screen_start=yAxis.scale().invert(0);
  screen_end=yAxis.scale().invert(height-xaxisheight);
  zoom.translateBy(heatmapregion,0,-(screen_end-screen_start)*xyratio);
}

function moveUp() {
  // xyratio = xyratio / 2;
  // zoom.translateBy(svg,0,0);
  screen_start=yAxis.scale().invert(0);
  screen_end=yAxis.scale().invert(height-xaxisheight);
  zoom.translateBy(heatmapregion,0,(screen_end-screen_start)*xyratio);
}

function onclick() {
  console.log("click")

  var pos = d3.mouse(heatmap.node()), cx = Math.round(xScale.invert(pos[0])), cy = Math.round(yScale.invert(pos[1]));
  var posx = xScale.invert(pos[0]), posy = yScale.invert(pos[1]);

  focus.select('#focusLineY')
      .attr('x1', Math.round(posx+0.5)-0.5).attr('y1', 0)
      .attr('x2', Math.round(posx+0.5)-0.5).attr('y2', ids.length);
  focus.select('#focusLineX')
      .attr('x1', 0).attr('y1', Math.round(posy)+0.5)
      .attr('x2', samples.length).attr('y2', Math.round(posy)+0.5);

  ctax = yticklabels[cy]; 
  cid = ids[cy];
  csamp = samples[cx];
  document.getElementById("taxonomy").innerHTML = ctax;
  document.getElementById("sampleid").innerHTML = csamp;
  // Get dbBact annotations for selection
  $.ajax({
    url: 'http://dbbact.org/REST-API/sequences/get_string_annotations',
    type: 'POST',
    data: JSON.stringify({'sequence': cid}),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function(data) {
        var atext="";
        clink = "http://dbbact.org/sequence_annotations/" + cid;
        ctext = "<a href='" + clink + "' target='_blank'>dbBact Summary</a><br>";
        atext += ctext
        for (i = 0; i < data.annotations.length; i++) { 
            clink = "http://dbbact.org/annotation_info/" + data.annotations[i].annotationid.toString();
            ctext = "<a href='" + clink + "' target='_blank'>" + data.annotations[i].annotation_string + "</a><br>";
            atext += ctext
            };
          document.getElementById("annotations").innerHTML = atext;
    }
  });
}

function get_xyratio() {
  return (hheight/ids.length) * (samples.length/hwidth)
}

</script>
</body>
</html>